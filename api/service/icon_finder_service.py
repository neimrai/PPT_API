import json
import chromadb
import os
from chromadb.config import Settings
from chromadb.utils.embedding_functions import ONNXMiniLM_L6_V2


class IconFinderService:
    def __init__(self):
        # 图标集合名称
        self.collection_name = "icons"
        # 初始化ChromaDB客户端，禁用遥测
        self.client = chromadb.PersistentClient(
            path="chroma", settings=Settings(anonymized_telemetry=False)
        )
        print('正在初始化图标集合...')
        self._initialize_icons_collection()
        print('图标集合初始化完成。')
    
    def _initialize_icons_collection(self):
        # 初始化嵌入函数
        self.embedding_function = ONNXMiniLM_L6_V2()
        # 设置模型下载路径
        self.embedding_function.DOWNLOAD_PATH = "chroma/models"
        # 如果模型不存在则下载
        self.embedding_function._download_model_if_not_exists()
        try:
            # 尝试获取已存在的图标集合
            self.collection = self.client.get_collection(
                self.collection_name, embedding_function=self.embedding_function
            )
        except Exception:
            # 如果集合不存在，从JSON文件加载图标数据
            with open("api/assets/icons.json", "r",encoding="utf-8") as f:
                icons = json.load(f)

            documents = []
            ids = []                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                

            # 只处理粗体图标
            for i, each in enumerate(icons["icons"]):
                if each["name"].split("-")[-1] == "bold":
                    doc_text = f"{each['name']} {each['tags']}"
                    documents.append(doc_text)
                    ids.append(each["name"])

            if documents:
                # 创建新的图标集合
                self.collection = self.client.create_collection(
                    name=self.collection_name,
                    embedding_function=self.embedding_function,
                    metadata={"hnsw:space": "cosine"},  # 使用余弦相似度作为向量空间度量
                )
                # 添加图标数据到集合
                self.collection.add(documents=documents, ids=ids)

    def search_icons(self, query: str, k: int = 1):
        """
        搜索图标
        :param query: 搜索关键词
        :param k: 返回结果数量
        :return: 匹配图标的URL列表
        """
        # 直接执行查询
        result = self.collection.query(
            query_texts=[query],
            n_results=k,
        )
        # 返回图标URL列表
        return [f"/static/icons/bold/{each}.png" for each in result["ids"][0]]
